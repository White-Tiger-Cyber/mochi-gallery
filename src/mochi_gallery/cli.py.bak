import argparse
import os
import json
import sys
from .client import get_client, fetch_haiku, generate_image_prompt, generate_image_native, get_design_directives
from .painter import render_poster

def main():
    parser = argparse.ArgumentParser(description="Mochimo Gallery Generator")
    parser.add_argument("block_number", type=int, help="Mochimo Block Number")
    parser.add_argument("--style", type=str, help="Path to JSON style file", default=None)
    parser.add_argument("--output", type=str, help="Output directory", default="output")
    parser.add_argument("--mock", action="store_true", help="Skip API calls and use placeholder images (free)")
    
    args = parser.parse_args()

    # Setup directories
    os.makedirs(args.output, exist_ok=True)
    os.makedirs(os.path.join(args.output, "raw"), exist_ok=True)

    # --- INITIALIZATION ---
    style_data = None
    file_prefix = ""
    # CRITICAL FIX: Initialize this here, NOT inside the 'if' block
    aspect_ratio = "3:4" 
    VALID_RATIOS = ["1:1", "3:4", "4:3", "9:16", "16:9"]

    # --- LOAD STYLE ---
    if args.style:
        if os.path.exists(args.style):
            try:
                file_prefix = f"{os.path.splitext(os.path.basename(args.style))[0]}_"
                with open(args.style, 'r') as f:
                    style_data = json.load(f)
                    
                if "aspect_ratio" in style_data:
                    if style_data["aspect_ratio"] in VALID_RATIOS:
                        aspect_ratio = style_data["aspect_ratio"]
                    else:
                        print(f"Warning: Invalid aspect ratio in JSON. Defaulting to 3:4.")
            except Exception as e:
                print(f"Error loading style: {e}")
                sys.exit(1)
        else:
            print(f"Style file not found: {args.style}")
            sys.exit(1)

    # --- EXECUTION ---
    client = get_client()
    haiku = fetch_haiku(args.block_number)
    
    if not haiku or "no haiku" in haiku.lower():
        print("No haiku found.")
        return

    print(f"--- Block {args.block_number} ---")
    print(haiku)

    # 1. Generate Prompt (Skip if mocking to save time)
    if args.mock:
        prompt = "Mock prompt for testing logic."
    else:
        prompt = generate_image_prompt(client, haiku, style_data, aspect_ratio)

    # 2. Generate Image (Or Grey Box if --mock)
    img = generate_image_native(client, prompt, aspect_ratio, mock=args.mock)
    
    raw_path = os.path.join(args.output, "raw", f"{file_prefix}raw_{args.block_number}.png")
    img.save(raw_path)

    # 3. Design Analysis (We allow this even in mock mode usually, as Gemini Flash is cheap/free)
    # If you want to mock this too, you can, but analysing the grey box is a good test.
    design = get_design_directives(client, img, haiku)
    
    # 4. Render
    poster = render_poster(img, haiku, args.block_number, design)
    
    out_path = os.path.join(args.output, f"{file_prefix}block_{args.block_number}.png")
    poster.save(out_path)
    print(f"Saved: {out_path}")

if __name__ == "__main__":
    main()
